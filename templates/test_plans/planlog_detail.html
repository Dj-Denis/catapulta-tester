{% extends 'base.html' %}
{% load i18n %}
{% block content %}
    <div class="section section--hero">
        <div class="section__content">
            <div class="container-fludi container-wide">
                <div class="card">
                    <article class="card-body">
                        <a class="card-title text-dark" href={% url 'plan_detail' planlog.plan_id %}>{{ planlog.plan.name }}</a>

                        <table class="display_plan_cases table table-lg table-hover border justify-content-center">
                            <thead>
                            <tr>
                                <th></th>
                                <th scope="col">ID</th>
                                <th scope="col">{% trans "Название тест кейса" %}</th>
                                <th scope="col">{% trans "Дата запуска" %}</th>
                                <th scope="col">{% trans "Запустил" %}</th>
                                <th scope="col">{% trans "Статут запуска" %}</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>
                    </article>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}
    <script>

        function format(d) {
            return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                '<tr>' +
                '<td>Коментарий:</td>' +
                '<td>' + d.comment + '</td>' +
                '</tr>' +
                '</table>';
        }

        $(document).ready(function () {
            var table = $('table.display_plan_cases').DataTable({
                "searching": false,
                "lengthChange": false,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Russian.json"
                },
                "ordering": false,
                "serverSide": true,
                "ajax": {"url": "{% url 'case_log_plan_rel' planlog.pk %}?format=datatables&columns[6][data]=comment",},
                "columns": [
                    {
                        "className": 'details-control',
                        "orderable": false,
                        "data": null,
                        "defaultContent": '',
                    },
                    {data: "case.id"},
                    {
                        data: "case",
                        render: function (data, type, row) {
                            return "<a class=\"text-dark\" href=" + document.location.origin + data.url + ">" + data.name + "</a>"
                        }
                    },
                    {
                        data: "last_run",
                        render: function (data, type, row) {
                            return moment(data).locale('ru').format('D MMMM YYYY г. H:mm');
                        }
                    },
                    {data: "run_by.get_full_name"},
                    {
                        data: "status",
                        "createdCell": function (td, cellData, rowData, row, col) {
                            switch (cellData) {
                                case '1':
                                    $(td).addClass('text-center bg-success text-light rounded');
                                    break;
                                case '0':
                                    $(td).addClass('text-center bg-danger text-light rounded');
                                    break;
                                default:
                                    $(td).addClass('text-center bg-secondary text-light rounded');
                                    break;
                            }
                        },
                        render: function (data, type, row) {
                            if (data === '0') return "Провалено";
                            else return "Успешно";
                        },
                    },
                ]

            });

            $('table.display_plan_cases tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
        });

    </script>
{% endblock %}