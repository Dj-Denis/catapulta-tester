{% extends "base.html" %}
{% load i18n %}
{% block content %}

    <div class="section section--hero">
        <div class="section__content">
            <div class="container-fludi container-wide">
                <div class="card">
                    <article class="card-body">
                        <div class="text-center"><h2 class="section__title">Тест план</h2></div>
                        <div class="row">
                            <div class="col-7">
                                <h4 class="plan__title">{{ plan.name }}</h4>
                            </div>
                            <div class="col-5 text-right">
                                <a class="btn btn-info"
                                   href={% url "plan_edit" plan.pk %}> {% trans "Редактировать" %}</a>
                                <a class="btn btn-primary"
                                   href="{% url "plan_run" %}?plan_id={{ plan.pk }}">{% trans "Запустить план" %}</a>
                                <a class="btn btn-warning"
                                   href={% url 'plan_list' %}> {% trans "Вернутся в список" %}</a>
                                <a class="btn btn-danger" href={% url 'plan_delete' plan.pk %}>{% trans "Удалить" %}</a>
                                {#                                <a class="btn btn-success" href="{% url 'plan_csv' plan.pk %}">Експорт в CSV</a>#}
                            </div>
                        </div>
                        <div class="plan__decription">
                            {{ plan.description }}
                        </div>
                        <h2 class="planDetail__title mt-2">{% trans "Детали тест плана" %}</h2>
                        <div class="planDetail__table">
                            <table class="display_plan_cases table table-lg table-hover border justify-content-center">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th scope="col">ID</th>
                                    <th scope="col">{% trans "Название тест кейса" %}</th>
                                    <th scope="col">{% trans "Дата последнего запуска" %}</th>
                                    <th scope="col">{% trans "Запустил" %}</th>
                                    <th scope="col">{% trans "Статут запуска" %}</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                        <h2 class="planLog__title">{% trans "Лог тест плана" %}</h2>
                        <div class="planLog__table">
                            <table class="display_plan_log table table-lg table-hover border align-middle">
                                <thead>
                                <tr>
                                    <th scope="col">{% trans "Дата последнего запуска" %}</th>
                                    <th scope="col">{% trans "Запустил" %}</th>
                                    <th scope="col">{% trans "Статус запуска" %}</th>
                                    <th>{% trans "Коментарий" %}</th>
                                </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </article>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block script %}

    <script>

        function format(d) {
            if (d.comment == null) {
                return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                    '<tr>' +
                    '<td>Коментарий:</td>' +
                    '<td>' + '' + '</td>' +
                    '</tr>' +
                    '</table>';
            }
            else {
                return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">' +
                    '<tr>' +
                    '<td>Коментарий:</td>' +
                    '<td>' + d.comment + '</td>' +
                    '</tr>' +
                    '</table>';
            }
        }

        $(document).ready(function () {

            var table_1 = $('table.display_plan_cases').DataTable({
                "searching": false,
                "lengthChange": false,
                "ordering": false,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Russian.json"
                },
                "serverSide": true,
                {% if plan.last_log.pk %}
                    "ajax": {"url": "{% url 'case_log_plan_rel' plan.last_log.pk %}?format=datatables&columns[6][data]=comment",},
                    "columns": [
                        {
                            "className": 'details-control',
                            "orderable": false,
                            "data": null,
                            "defaultContent": '',
                        },
                        {data: "case.id"},
                        {
                            data: "case",
                            render: function (data, type, row) {
                                return "<a class=\"text-dark\" href=" + document.location.origin + data.url + ">" + data.name + "</a>"
                            },
                            "width": "200px"
                        },
                        {
                            data: "last_run",
                            render: function (data, type, row) {
                                return moment(data).locale('ru').format('D MMMM YYYY г. H:mm');
                            }
                        },
                        {data: "run_by.get_full_name"},
                        {
                            data: "status",
                            "createdCell": function (td, cellData, rowData, row, col) {
                                switch (cellData) {
                                case '1':
                                    $(td).addClass('text-center bg-success text-light rounded align-middle');
                                    break;
                                case '2':
                                    $(td).addClass('text-center bg-danger text-light rounded align-middle');
                                    break;
                                default:
                                    $(td).addClass('text-center bg-secondary text-light rounded align-middle');
                                    break;
                            }
                            },
                           render: function (data, type, row) {
                            if (data === '2') return "Провалено";
                            else return "Успешно";
                        },
                        },
                    ],
                {% else %}
                    "ajax": {"url": "{% url 'case_plan_rel' plan.pk %}?format=datatables&columns[6][data]=name&columns[7][data]=url",},
                    "columns": [
                        {
                            "className": 'details-control align-middle',
                            "orderable": false,
                            "data": null,
                            "defaultContent": '',
                        },
                        {data: "id"},
                        {
                            render: function (data, type, row) {
                                console.log(row);
                                return "<a class=\"text-dark\" href=" + document.location.origin + row.url +">" + row.name + "</a>"
                            },
                            "className": "align-middle"

                        },
                        {
                            data: '',
                            render: function () {
                                return '';
                            },
                            "className": "align-middle"
                        },
                        {
                            data: '',
                            render: function () {
                                return '';
                            },
                            "className": "align-middle"
                        },
                        {
                            data: 'id',
                            "createdCell": function (td, cellData, rowData, row, col) {
                                $(td).addClass('text-center bg-secondary text-light rounded');
                                },
                            render: function () {
                             return "Не запускалось"
                            },
                            "className": "align-middle"
                        },
                    ],
                {% endif %}

            });

            $('table.display_plan_cases tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table_1.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    console.log(row.data());
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });

            var table_2 = $('table.display_plan_log').DataTable({
                "searching": false,
                "lengthChange": false,
                "ordering": false,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.10.19/i18n/Russian.json"
                },
                "serverSide": true,
                "ajax": {"url": "{% url 'rel_plan_log' plan.pk %}?format=datatables&columns[4][data]=comment&columns[5][data]=url&columns[6][data]=last_run",},
                "columns": [
                    {
                        {#data: "",#}
                        render: function (data, type, row) {
                            var date = moment(row.last_run).locale('ru').format('D MMMM YYYY г. H:mm');
                            return "<a class=\"text-dark\" href=" + document.location.origin + row.url + ">" + date + "</a>"
                        },
                        "width": "200px",
                        "className": "align-middle"
                    },
                    {
                        "data": "run_by.get_full_name",
                        "width": "150px",
                        "className": "align-middle"
                    },
                    {
                        data: "status",
                        "createdCell": function (td, cellData, rowData, row, col) {
                            switch (cellData) {
                                case '1':
                                    $(td).addClass('text-center bg-success text-light rounded align-middle');
                                    break;
                                case '0':
                                    $(td).addClass('text-center bg-danger text-light rounded align-middle');
                                    break;
                                default:
                                    $(td).addClass('text-center bg-secondary text-light rounded align-middle');
                                    break;
                            }
                        },
                        render: function (data, type, row) {
                            if (data === '0') return "Провалено";
                            else return "Успешно";
                        },
                        "width": "200px",
                        "className": "align-middle"
                    },
                    {
                        data: "comment",
                        "className": "align-middle"
                    }

                ],

            });

            $('table.display_plan_log tbody').on('click', 'td.details-control', function () {
                var tr = $(this).closest('tr');
                var row = table_2.row(tr);

                if (row.child.isShown()) {
                    row.child.hide();
                    tr.removeClass('shown');
                }
                else {
                    console.log(row.ajax.json());
                    row.child(format(row.data())).show();
                    tr.addClass('shown');
                }
            });
        })
    </script>
{% endblock %}